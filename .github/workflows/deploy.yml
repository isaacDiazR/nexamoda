name: Deploy NexaModa to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Configure SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: ğŸ“¦ Deploy to Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -p $SSH_PORT $SSH_USER@$SSH_HOST << 'EOF'
            # Crear directorio si no existe
            mkdir -p ~/nexamoda
            cd ~/nexamoda
            
            # Clonar o actualizar repositorio
            if [ -d ".git" ]; then
              echo "ğŸ“¥ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            else
              echo "ğŸ“¥ Clonando repositorio..."
              git clone https://github.com/${{ github.repository }} .
            fi
            
            # Detener contenedores anteriores
            echo "ğŸ›‘ Deteniendo contenedores anteriores..."
            docker compose -f docker-compose.prod.yml down 2>/dev/null || true
            
            # Construir y levantar contenedores
            echo "ğŸ”¨ Construyendo y desplegando..."
            docker compose -f docker-compose.prod.yml up -d --build
            
            # Verificar que estÃ© corriendo
            echo "âœ… Verificando contenedores..."
            docker compose -f docker-compose.prod.yml ps
            
            # Limpiar imÃ¡genes antiguas
            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
            docker image prune -f
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ NexaModa disponible en puerto 3000"
          EOF

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: âœ… Deployment Status
        run: |
          echo "ğŸ‰ NexaModa deployed successfully!"
          echo "ğŸŒ Check your server: http://${{ secrets.SSH_HOST }}:3000"
